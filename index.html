<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
  <title>p5.js Responsive Example</title>
  <style>
    img {
      display: block;
      position: absolute;
    }
  </style>
</head>
<body>
  <script>
    let backgroundImages = [];
    let motifImages = [];
    let countEnjoyment = 0, countDisgust = 0, countSadness = 0, countFear = 0, countAnger = 0;
    let selectedBackground, selectedMotif;

    let buttons = {};
    let sparkles = [];
    let sparkleDuration = 2000; // キラキラの表示時間
    let sparkleColors = {
      'Enjoyment': '#FF4500',
      'Sadness': '#FFD700',
      'Disgust': '#006400',
      'Fear': '#550000',
      'Anger': '#006699'
    };

    function preload() {
      // 背景画像の読み込み
      backgroundImages[0] = loadImage('https://mooo0ooo.github.io/diary/background1.png');
      backgroundImages[1] = loadImage('https://mooo0ooo.github.io/diary/background2.png');
      backgroundImages[2] = loadImage('https://mooo0ooo.github.io/diary/background3.png');
      backgroundImages[3] = loadImage('https://mooo0ooo.github.io/diary/background4.png');

      // モチーフ画像の読み込み
      motifImages['Enjoyment'] = loadImage('https://mooo0ooo.github.io/diary/sun-removebg-preview.png');
      motifImages['Disgust'] = loadImage('https://mooo0ooo.github.io/diary/shooting_star-removebg-preview.png');
      motifImages['Sadness'] = loadImage('https://mooo0ooo.github.io/diary/moon-removebg-preview.png');
      motifImages['Fear'] = loadImage('https://mooo0ooo.github.io/diary/fireworks-removebg-preview.png');
      motifImages['Anger'] = loadImage('https://mooo0ooo.github.io/diary/star-removebg-preview.png');
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
      background(255);

      // 感情のボタンを画像として作成
      buttons.enjoyment = createImg('https://mooo0ooo.github.io/diary/sun-removebg-preview.png', 'Enjoyment').mousePressed(() => { handleEmotionButton('Enjoyment'); });
      buttons.disgust = createImg('https://mooo0ooo.github.io/diary/shooting_star-removebg-preview.png', 'Disgust').mousePressed(() => { handleEmotionButton('Disgust'); });
      buttons.sadness = createImg('https://mooo0ooo.github.io/diary/moon-removebg-preview.png', 'Sadness').mousePressed(() => { handleEmotionButton('Sadness'); });
      buttons.fear = createImg('https://mooo0ooo.github.io/diary/fireworks-removebg-preview.png', 'Fear').mousePressed(() => { handleEmotionButton('Fear'); });
      buttons.anger = createImg('https://mooo0ooo.github.io/diary/star-removebg-preview.png', 'Anger').mousePressed(() => { handleEmotionButton('Anger'); });

      // Checkボタンを作成
      buttons.check = createButton('Check').mousePressed(displayArtwork);

      // Downloadボタンを作成（初めは非表示）
      buttons.download = createButton('Download Image').mousePressed(downloadImage);
      buttons.download.hide();

      positionButtons();  // ボタンの配置を実行
    }

    function handleEmotionButton(emotion) {
      // 感情のカウントを増加
      switch (emotion) {
        case 'Enjoyment': countEnjoyment++; break;
        case 'Disgust': countDisgust++; break;
        case 'Sadness': countSadness++; break;
        case 'Fear': countFear++; break;
        case 'Anger': countAnger++; break;
      }

      // キラキラを生成
      createSparkles(emotion);
    }

    function createSparkles(emotion) {
      let numSparkles = 20; // キラキラの数

      sparkles = [];

      for (let i = 0; i < numSparkles; i++) {
        let x = random(width);
        let y = random(height);
        let size = random(1, 3);

        sparkles.push({
          x: x,
          y: y,
          size: size,
          color: sparkleColors[emotion],
          outlineColor: sparkleColors[emotion],
          shape: random(['circle', 'star', 'hexagon', 'diamond']), // 形をランダムに
          alpha: 255
        });
      }

      // 2秒後に消える
      setTimeout(() => {
        sparkles = []; // キラキラを消去
      }, sparkleDuration);
    }

    function draw() {
      background(255);

      if (!selectedMotif) {
        drawSparkles();
      }
      
      drawArtwork(); 
    }

    function drawSparkles() {
      for (let sparkle of sparkles) {
        fill(sparkle.color);
        stroke(sparkle.outlineColor);
        strokeWeight(2);
        noFill();

        switch (sparkle.shape) {
          case 'circle':
            ellipse(sparkle.x, sparkle.y, sparkle.size);
            break;
          case 'star':
            drawStar(sparkle.x, sparkle.y, sparkle.size, sparkle.size * 1.5, 5); // 星の描画
            break;
          case 'hexagon':
            drawPolygon(sparkle.x, sparkle.y, sparkle.size, 6); // 六角形の描画
            break;
          case 'diamond':
            drawPolygon(sparkle.x, sparkle.y, sparkle.size, 4); // ダイヤの描画
            break;
        }
      }
    }

    // 星を描画する関数
    function drawStar(x, y, radius1, radius2, npoints) {
      let angle = TWO_PI / npoints;
      let halfAngle = angle / 2.0;
      beginShape();
      for (let a = 0; a < TWO_PI; a += angle) {
        let sx = x + cos(a) * radius2;
        let sy = y + sin(a) * radius2;
        vertex(sx, sy);
        sx = x + cos(a + halfAngle) * radius1;
        sy = y + sin(a + halfAngle) * radius1;
        vertex(sx, sy);
      }
      endShape(CLOSE);
    }

    // 多角形を描画する関数
    function drawPolygon(x, y, radius, npoints) {
      let angle = TWO_PI / npoints;
      beginShape();
      for (let a = 0; a < TWO_PI; a += angle) {
        let sx = x + cos(a) * radius;
        let sy = y + sin(a) * radius;
        vertex(sx, sy);
      }
      endShape(CLOSE);
    }

    // ボタンの位置とサイズを画面サイズに基づいて調整する関数
    function positionButtons() {
      let buttonSize = min(windowWidth, windowHeight) * 0.08; // ボタンの大きさを画面のサイズに応じて調整
      let buttonMargin = buttonSize * 0.2; // ボタン間のマージン
      let topMargin = windowHeight * 0.05; // 上からのマージン

      // ボタンの横方向の中心配置
      let totalWidth = (buttonSize * 5) + (buttonMargin * 4); // 5つのボタン幅と間のマージンの合計
      let startX = (windowWidth - totalWidth) / 2;  // 画面中央から配置開始

      // 各感情ボタンの位置を設定
      buttons.enjoyment.position(startX, topMargin).size(buttonSize, buttonSize);
      buttons.disgust.position(startX + (buttonSize + buttonMargin), topMargin).size(buttonSize, buttonSize);
      buttons.sadness.position(startX + (buttonSize + buttonMargin) * 2, topMargin).size(buttonSize, buttonSize);
      buttons.fear.position(startX + (buttonSize + buttonMargin) * 3, topMargin).size(buttonSize, buttonSize);
      buttons.anger.position(startX + (buttonSize + buttonMargin) * 4, topMargin).size(buttonSize, buttonSize);

      // チェックボタンを画面の右下に配置
      buttons.check.position(windowWidth - buttonSize - buttonMargin, windowHeight - buttonSize - topMargin).size(buttonSize, buttonSize);
      buttons.download.position(windowWidth - buttonSize - buttonMargin, windowHeight - (buttonSize * 2) - topMargin).size(buttonSize, buttonSize);
    }

    // ウィンドウリサイズ時にキャンバスとボタンの位置を再設定
    function windowResized() {
      resizeCanvas(windowWidth, windowHeight);
      positionButtons();  // ボタンの再配置
    }

    function displayArtwork() {
      let totalGroup1 = countEnjoyment; // Group 1: Enjoyment
      let totalGroup2 = countDisgust + countSadness + countFear + countAnger; // Group 2: 他の感情

      // 背景の決定
      let ratio = totalGroup1 / (totalGroup1 + totalGroup2);  // Group 1 と Group 2 の比率
      if (ratio >= 1) {
        selectedBackground = backgroundImages[0];  // 10:0 の比率
      } else if (ratio >= 0.6) {
        selectedBackground = backgroundImages[1];  // 6:4 の比率
      } else if (ratio >= 0.4) {
        selectedBackground = backgroundImages[2];  // 4:6 の比率
      } else {
        selectedBackground = backgroundImages[3];  // 0:10 の比率
      }

      // モチーフの決定（最も多く押された感情）
      let maxCount = Math.max(countEnjoyment, countDisgust, countSadness, countFear, countAnger);
      if (maxCount === countEnjoyment) {
        selectedMotif = motifImages['Enjoyment'];
      } else if (maxCount === countDisgust) {
        selectedMotif = motifImages['Disgust'];
      } else if (maxCount === countSadness) {
        selectedMotif = motifImages['Sadness'];
      } else if (maxCount === countFear) {
        selectedMotif = motifImages['Fear'];
      } else if (maxCount === countAnger) {
        selectedMotif = motifImages['Anger'];
      }

      // ボタンを隠す
      hideButtons();

    }

    function hideButtons() {
      // すべてのボタンを非表示に
      for (let key in buttons) {
        buttons[key].hide();
      }
    }

    function drawArtwork() {
      background(255);

      // 背景をスクエアとして表示
      if (selectedBackground) {
        let backgroundSize = min(width, height) * 0.8;  // 背景のサイズを画面に合わせて調整
        let padding = 20;  // 枠と背景の間のスペース

        // 背景画像を中央に表示
        image(selectedBackground, (width - backgroundSize) / 2, (height - backgroundSize) / 2, backgroundSize, backgroundSize);
      }

      // モチーフの描画
      if (selectedMotif) {
        let motifSize = min(width, height) * 0.6;  // モチーフのサイズを調整
        tint(255, 250);  // 透過
        image(selectedMotif, (width - motifSize) / 2, (height - motifSize) / 2, motifSize, motifSize);
        noTint();  // 描画後に透過をリセット
      }
    }

    function downloadImage() {
      // キャンバスを保存
      saveCanvas('artwork', 'png'); // 'artwork' という名前でPNG形式で保存
    }

  </script>
</body>
</html>
